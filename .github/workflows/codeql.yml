# This workflow runs CodeQL against the repository.
#
# Results are uploaded to GitHub Code Scanning.
#
# Copyright (c) Microsoft Corporation.
# SPDX-License-Identifier: BSD-2-Clause-Patent

name: "CodeQL"

on:
  push:
    branches:
      - release/*
  pull_request:
    branches:
      - release/*
    paths-ignore:
      - '!**.c'
      - '!**.h'

jobs:
  analyze:
    name: Analyze
    runs-on: windows-2022
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        package: [
          "CryptoPkg",
          "MdeModulePkg",
          "MdePkg",
          "NetworkPkg",
          "PcAtChipsetPkg",
          "PolicyServicePkg",
          "ShellPkg",
          "StandaloneMmPkg",
          "UefiCpuPkg",
          "UnitTestFrameworkPkg"]
        include:
          - archs: IA32,X64
          - tool_chain_tag: VS2022

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install/Upgrade pip Modules
      run: pip install -r pip-requirements.txt --upgrade

    - name: Setup
      run: stuart_setup -c .pytool/CISettings.py -t DEBUG -a ${{ matrix.archs }} TOOL_CHAIN_TAG=${{ matrix.tool_chain_tag }}

    - name: Update
      run: stuart_update -c .pytool/CISettings.py -t DEBUG -a ${{ matrix.archs }} TOOL_CHAIN_TAG=${{ matrix.tool_chain_tag }} --codeql

    - name: Remove CI Plugins Irrelevant to CodeQL
      shell: python
      run: |
        import os
        import shutil

        plugins_to_keep = ['CodeQL', 'CompilerPlugin']
        plugin_dir = os.path.join(os.environ['GITHUB_WORKSPACE'], '.pytool', 'Plugin')
        if os.path.isdir(plugin_dir):
            for dir in os.listdir(plugin_dir):
                if dir not in plugins_to_keep:
                    shutil.rmtree(os.path.join(plugin_dir, dir), ignore_errors=True)

    - name: CI Build
      run: stuart_ci_build -c .pytool/CISettings.py -t DEBUG -p ${{ matrix.package }} -a ${{ matrix.archs }} TOOL_CHAIN_TAG=${{ matrix.tool_chain_tag }} --codeql

    - name: Prepare Env Data for CodeQL Upload
      id: env_data
      env:
        PACKAGE_NAME: ${{ matrix.package }}
      shell: python
      run: |
        import os

        package = os.environ['PACKAGE_NAME'].strip().lower()
        directory_name = 'codeql-analysis-' + package + '-debug'
        file_name = 'codeql-db-' + package + '-debug-0.sarif'
        sarif_path = os.path.join('Build', directory_name, file_name)

        with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
            print(f'sarif_file_path={sarif_path}', file=fh)

    - name: Upload CodeQL Results (SARIF)
      uses: github/codeql-action/upload-sarif@v2
      with:
        # Path to SARIF file relative to the root of the repository.
        sarif_file: ${{ steps.env_data.outputs.sarif_file_path }}
        # Optional category for the results. Used to differentiate multiple results for one commit.
        # Each package is a separate category.
        category: ${{ matrix.package }}
